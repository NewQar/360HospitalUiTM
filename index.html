<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UiTM Hospital ‚Äî 360¬∞ Waypoint Prototype</title>

<!-- A-Frame CDN (includes Three.js) -->
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

<style>
  :root{
    --accent:#0b74de;
    --bg:#0f1720;
    --ui:#111827cc;
    --text:#e6eef6;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  .app {
    position:relative;
    height:100vh;
    width:100vw;
    overflow:hidden;
  }

  .topbar{
    position:absolute;left:12px;top:12px;z-index:50;
    background:linear-gradient(180deg, rgba(17,24,39,0.85), rgba(17,24,39,0.6));
    padding:10px 14px;border-radius:10px;backdrop-filter: blur(6px);
    box-shadow:0 6px 18px rgba(2,6,23,0.6);min-width:260px;
  }
  .topbar h1{margin:0;font-size:15px;letter-spacing:0.2px;}
  .topbar p{margin:6px 0 0 0;font-size:12px;opacity:0.9;}

  .map-panel{
    position:absolute; right:12px; top:12px; z-index:50;
    width:220px; background:var(--ui); padding:12px;border-radius:10px;
    box-shadow:0 6px 18px rgba(2,6,23,0.6);
    color:var(--text);
  }
  .map-title{font-size:13px;margin:0 0 8px 0}
  .mini-map{width:100%;height:140px;border-radius:6px; background:#0b1220;display:flex;align-items:center;justify-content:center;position:relative}
  .map-svg{width:90%;height:90%}
  .map-legend{font-size:11px;margin-top:8px; opacity:0.9;}

  .bottombar{
    position:absolute; left:12px; bottom:12px; z-index:50;
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  }
  .btn{
    background:var(--ui); color:var(--text); border-radius:8px; padding:8px 10px;
    font-size:13px; cursor:pointer; border:0; box-shadow:0 4px 12px rgba(2,6,23,0.4);
  }
  .btn:hover{background:rgba(17,24,39,0.95)}
  .status{
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    padding:8px 10px;border-radius:8px;font-size:13px;
  }
  .error{color:#ef4444}

  .loader {
    position:absolute; inset:0; z-index:60; display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg, rgba(3,7,18,0.5), rgba(3,7,18,0.4));
    backdrop-filter: blur(2px);
    visibility:hidden; opacity:0; transition:all .04s ease;
  }
  .loader.show{visibility:visible;opacity:1}
  .spinner{
    width:110px;height:110px;border-radius:12px;background:var(--ui);display:flex;align-items:center;justify-content:center;flex-direction:column;
    box-shadow:0 10px 30px rgba(2,6,23,0.6);
  }
  .spinner .dot{width:34px;height:34px;border-radius:50%;background:var(--accent);margin-bottom:8px;animation:pop 1s infinite alternate;}
  @keyframes pop{from{transform:scale(.86)}to{transform:scale(1.03)}}

  .note{position:absolute;left:50%;transform:translateX(-50%);bottom:22px;color:#cbd5e1;font-size:12px;opacity:0.8;z-index:45}

  /* Edit Panel */
  .edit-panel{
    position:absolute;left:12px;top:80px;z-index:50;width:300px;
    background:var(--ui);padding:0;border-radius:10px;
    box-shadow:0 6px 18px rgba(2,6,23,0.6);color:var(--text);
  }
  .edit-header{
    padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.1);
    display:flex;justify-content:space-between;align-items:center;
  }
  .edit-content{padding:12px 14px;max-height:70vh;overflow-y:auto;}
  .btn-close{
    background:transparent;border:0;color:var(--text);font-size:24px;
    cursor:pointer;padding:0;width:24px;height:24px;line-height:20px;
  }
  .edit-select{
    width:100%;padding:8px;background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.1);border-radius:6px;
    color:var(--text);font-size:12px;
  }
  .hotspot-item{
    padding:8px;background:rgba(255,255,255,0.03);border-radius:4px;
    margin-bottom:6px;font-size:11px;display:flex;justify-content:space-between;
    align-items:center;
  }
  .btn-remove{
    background:#dc2626;color:#fff;border:0;padding:4px 8px;
    border-radius:4px;cursor:pointer;font-size:10px;
  }
  .checkbox-group{
    margin:12px 0;padding:10px;background:rgba(255,255,255,0.03);border-radius:6px;
  }
  .checkbox-label{
    display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer;
  }
  .checkbox-label input{cursor:pointer}
</style>
</head>
<body>
<div class="app">

  <div class="topbar">
    <h1>UiTM Hospital ‚Äî 360¬∞ Waypoint Prototype</h1>
    <p id="locationLabel">Loading initial scene‚Ä¶</p>
  </div>

  <div class="map-panel">
    <div class="map-title">Floor map (prototype)</div>
    <div class="mini-map" id="miniMap">
      <svg class="map-svg" viewBox="0 0 200 100" preserveAspectRatio="xMidYMid meet">
        <rect x="0" y="0" width="200" height="100" rx="6" ry="6" fill="#0e1b2a"/>
        <g id="nodesSvg"></g>
        <path d="M20 50 L180 50" stroke="#243b57" stroke-width="6" stroke-linecap="round" />
      </svg>
    </div>
    <div class="map-legend"><strong>Legend:</strong> ‚óè Current ¬∑ Click signs/hotspots to move</div>
  </div>

  <div class="bottombar">
    <button class="btn" id="btn-recenter">Go To Clinic</button>
    <!-- <button class="btn" id="btn-debug">Toggle Debug</button>
    <button class="btn" id="btn-edit-mode">Edit Hotspots</button>
    <button class="btn" id="btn-toggle-signs">Toggle Signs</button> -->
    <div class="status" id="status">Ready</div>
  </div>

  <!-- Edit Mode Panel -->
  <div class="edit-panel" id="editPanel" style="display:none">
    <div class="edit-header">
      <strong>Edit Mode</strong>
      <button class="btn-close" id="btn-close-edit">√ó</button>
    </div>
    <div class="edit-content">
      <p style="margin:0 0 10px 0;font-size:12px">Click anywhere in the 360¬∞ view to place a navigation point</p>
      
      <label style="font-size:12px;display:block;margin-bottom:6px">Target Location:</label>
      <select id="targetSelect" class="edit-select">
        <option value="">-- Select destination --</option>
      </select>

      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="use3DSign" checked>
          <span>Use 3D Signage (Arrow + Text)</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="useHotspot" checked>
          <span>Use Hotspot Ring</span>
        </label>
      </div>
      
      <div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;font-size:11px">
        <div><strong>Last Clicked:</strong></div>
        <div id="clickInfo" style="margin-top:4px;color:#94a3b8">Click in view to see coordinates</div>
      </div>
      
      <button class="btn" id="btn-add-hotspot" style="width:100%;margin-top:12px" disabled>Add Navigation Point</button>
      
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1)">
        <strong style="font-size:12px">Current Navigation Points:</strong>
        <div id="hotspotList" style="margin-top:8px;max-height:150px;overflow-y:auto"></div>
      </div>
      
      <button class="btn" id="btn-export" style="width:100%;margin-top:12px;background:#059669">Export Config</button>
    </div>
  </div>

  <div class="note">Tip: Use mouse to look around. Click 3D signs or hotspots to navigate.</div>

  <div class="loader" id="loader">
    <div class="spinner">
      <div class="dot"></div>
      <div style="font-size:13px;margin-top:6px;color:var(--text)">Loading scene‚Ä¶</div>
    </div>
  </div>

  <a-scene embedded vr-mode-ui="enabled: false" renderer="antialias: true; colorManagement: true">
    <!-- Assets -->
    <a-assets>
      <!-- <img id="lobby-img" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/city.jpg" crossorigin="anonymous"> -->
      <img id="lobby-img" src="test1.jpg" crossorigin="anonymous">
      <!-- <img id="hall1-img" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/cubes.jpg" crossorigin="anonymous"> -->
       <img id="Recep-img" src="test2.jpg" crossorigin="anonymous">
      <img id="Bayaran-img" src="test3.jpg" crossorigin="anonymous">
      <img id="hall1-img" src="test4.jpg" crossorigin="anonymous">
      <img id="hall2-img" src="test5.jpg" crossorigin="anonymous">
      <img id="hall3-img" src="test6.jpg" crossorigin="anonymous">
      <img id="hall4-img" src="test7.jpg" crossorigin="anonymous">
      <img id="hall5-img" src="test8.jpg" crossorigin="anonymous">
      <img id="Clinic-img" src="test9.jpg" crossorigin="anonymous">
    </a-assets>

    <a-entity id="cameraRig" position="0 1.6 0">
      <a-entity id="camera" camera look-controls wasd-controls>
        <a-entity id="cursor" cursor="fuse: false; rayOrigin: mouse"
                  raycaster="objects: .hotspot, .sign-clickable"
                  position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.015; radiusOuter: 0.025"
                  material="color: #fff; shader: flat; opacity: 0.9">
        </a-entity>
      </a-entity>
    </a-entity>

    <a-sky id="sky" radius="5000" src="#lobby-img" rotation="0 5 0"></a-sky>
<a-entity id="pathlines"></a-entity>
    <a-entity id="hotspots"></a-entity>
    <a-entity id="signs"></a-entity>

    <a-entity light="type: ambient; color: #ffffff; intensity: 0.4"></a-entity>
    <a-entity light="type: directional; color: #ffffff; intensity: 0.5" position="1 1 0"></a-entity>
  </a-scene>

</div>

<script>

// NEW: dashed line component using Three.js LineDashedMaterial
AFRAME.registerComponent('dashed-line', {
  schema: {
    start:   { type: 'vec3', default: { x: 0, y: -1.6, z: 0 } },
    end:     { type: 'vec3', default: { x: 0, y: -1.6, z: -3 } },
    color:   { type: 'color', default: '#ffd166' },
    dashLen: { type: 'number', default: 0.15 },
    gapLen:  { type: 'number', default: 0.2 },
    radius:  { type: 'number', default: 0.05 },
    opacity: { type: 'number', default: 0.5 }
  },

  init() {
    this.group = new THREE.Group();
    this.el.object3D.add(this.group);
  },

  update() {
    const d = this.data;

    // clear old
    while (this.group.children.length) {
      const obj = this.group.children.pop();
      obj.geometry.dispose();
      obj.material.dispose();
    }

    const start = new THREE.Vector3(d.start.x, d.start.y, d.start.z);
    const end   = new THREE.Vector3(d.end.x, d.end.y, d.end.z);

    const dir = new THREE.Vector3().subVectors(end, start);
    const totalLen = dir.length();
    if (totalLen < 0.001) return;

    dir.normalize();

    const material = new THREE.MeshBasicMaterial({
      color: new THREE.Color(d.color),
      transparent: true,
      opacity: d.opacity,
      side: THREE.DoubleSide,  // Render both sides
      depthTest: true,         // Enable depth testing
      depthWrite: false
    });

    // build dashed cylinders
    let travelled = 0;
    while (travelled < totalLen) {
      const segLen = Math.min(d.dashLen, totalLen - travelled);
      const a = start.clone().add(dir.clone().multiplyScalar(travelled));
      const b = start.clone().add(dir.clone().multiplyScalar(travelled + segLen));

      const mid = a.clone().add(b).multiplyScalar(0.5);
      const cyl = new THREE.CylinderGeometry(d.radius, d.radius, segLen, 12, 1, false); // More segments, not open

      const mesh = new THREE.Mesh(cyl, material.clone());
      mesh.position.copy(mid);

      // rotate cylinder to align with direction
      mesh.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), dir);

      mesh.renderOrder = 1000; // Higher render order
      this.group.add(mesh);

      travelled += (d.dashLen + d.gapLen);
    }
  },

  remove() {
    while (this.group.children.length) {
      const obj = this.group.children.pop();
      obj.geometry.dispose();
      obj.material.dispose();
    }
    this.el.object3D.remove(this.group);
  }
});



(function() {
  'use strict';
  
  console.log('Script starting...');

  // Navigation configuration
  const nodes = {
    "lobby": {
      id: "lobby",
      title: "Main Lobby",
      type: "image",
      src: "#lobby-img",
      mapPos: {x: 30, y: 80},
      neighbors: [
        {id: "Receptionist", yaw: 110, pitch: 10, jauh:5.5, use3DSign: true, useHotspot: false},
        {id: "Kaunter Bayaran", yaw: 60, pitch: 12, jauh: 6, use3DSign: true, useHotspot: false},
        {id: "hall1", yaw: 0, pitch: 15, jauh:6, use3DSign: false, useHotspot: true}
      ]
    },
    "Receptionist": {
      id: "Receptionist",
      title: "Receptionist",
      type: "image",
      src: "#Recep-img",
      mapPos: {x: 80, y: 80},
      neighbors: [
        {id: "lobby", yaw: -1, pitch: 0, jauh:5.3, use3DSign: true, useHotspot: false},
        {id: "Kaunter Bayaran", yaw: 130, pitch: 10, jauh:5.5,use3DSign: true, useHotspot: false}
      ]
    },
    "Kaunter Bayaran": {
      id: "Kaunter Bayaran",
      title: "Kaunter Bayaran",
      type: "image",
      src: "#Bayaran-img",
      mapPos: {x: 150, y: 60},
      neighbors: [
        {id: "Receptionist", yaw: 108, pitch: 10, jauh:5.5, use3DSign: true, useHotspot: false},
        {id: "lobby", yaw: 155, pitch: 12.5, jauh:5.5, use3DSign: true, useHotspot: false}
      ]
    },
    "hall1": {
      id: "hall1",
      title: "Hall 1",
      type: "image",
      src: "#hall1-img",
      mapPos: {x: 120, y: 20},
      neighbors: [
        {id: "lobby", yaw: 173, pitch: 15, jauh:5.5, use3DSign: false, useHotspot: true},
        {id: "hall2", yaw: -5, pitch:15, jauh:5.5, use3DSign: false, useHotspot: true}
      ]
    },

        "hall2": {
      id: "hall2",
      title: "hall2",
      type: "image",
      src: "#hall2-img",
      mapPos: {x: 150, y: 20},
      neighbors: [
        {id: "hall1", yaw: 180, pitch: 15, jauh:5.5, use3DSign: false, useHotspot: true},
        {id: "hall3", yaw: 20, pitch:15, jauh:5.5, use3DSign: false, useHotspot: true}
      ]
    },

        "hall3": {
      id: "hall3",
      title: "hall3",
      type: "image",
      src: "#hall3-img",
      mapPos: {x: 90, y: 20},
      neighbors: [
        {id: "hall2", yaw: 125, pitch: 10, jauh:4.5, use3DSign: false, useHotspot: true},
        {id: "hall4", yaw: 1, pitch:18, jauh:5.5, use3DSign: false, useHotspot: true}
      ]
    },

        "hall4": {
      id: "hall4",
      title: "hall4",
      type: "image",
      src: "#hall4-img",
      mapPos: {x: 60, y: 20},
      neighbors: [
        {id: "hall3", yaw: 170, pitch: 15, jauh:5.5, use3DSign: false, useHotspot: true},
        {id: "hall5", yaw: -10, pitch:15, jauh:5.5, use3DSign: false, useHotspot: true}
      ]
    },

      "hall5": {
      id: "hall5",
      title: "hall5",
      type: "image",
      src: "#hall5-img",
      mapPos: {x: 60, y: 20},
      neighbors: [
        {id: "hall4", yaw: 181, pitch: 10, jauh:4.5, use3DSign: false, useHotspot: true},
        {id: "Clinic", yaw:1, pitch:12, jauh:5, use3DSign: false, useHotspot: true}
      ]
    },

      "Clinic": {
      id: "Clinic",
      title: "Clinic",
      type: "image",
      src: "#Clinic-img",
      mapPos: {x: 60, y: 20},
      neighbors: [
        {id: "hall5", yaw: -130, pitch:15, jauh:5.5, use3DSign: false, useHotspot: true}
      ]
    }
  };

let sky, hotspotsContainer, signsContainer, pathLinesContainer, loader, statusEl, locationLabel, miniMapGroup;
  let currentNodeId = null;
  let isTransitioning = false;
  let debugMode = false;
  let editMode = false;
  let showSigns = true;
  let lastClickedYaw = 0;
  let lastClickedPitch = 0;
  let journeyInProgress = false;

  function sphericalToCartesian(yawDeg, pitchDeg, radius) {
    radius = radius || 3;
    const yaw = THREE.MathUtils.degToRad(yawDeg);
    const pitch = THREE.MathUtils.degToRad(pitchDeg);
    const x = radius * Math.cos(pitch) * Math.sin(yaw);
    const y = radius * Math.sin(pitch);
    const z = -radius * Math.cos(pitch) * Math.cos(yaw);
    return {x:x, y:y, z:z};
  }

  // Create 3D directional sign with arrow
function create3DSign(neighbor, targetNode) {
  const pos = sphericalToCartesian(neighbor.yaw || 0, (neighbor.pitch || 0), neighbor.jauh);
  
  // Container for the sign
  const signGroup = document.createElement('a-entity');
  signGroup.setAttribute('position', pos.x + ' ' + pos.y + ' ' + pos.z);
  signGroup.setAttribute('rotation', '0 ' + (-neighbor.yaw) + ' 0');
  signGroup.setAttribute('class', 'sign-group');
  signGroup.setAttribute('data-target', neighbor.id);
  
  // Sign board (panel background)
  const board = document.createElement('a-entity');
  board.setAttribute('geometry', 'primitive: box; width: 0.8; height: 0.3; depth: 0.05');
  board.setAttribute('material', 'color: #0b74de; shader: flat; opacity: 0.95');
  board.setAttribute('class', 'sign-clickable');
  signGroup.appendChild(board);
  
  // Text label on sign
  const text = document.createElement('a-entity');
  text.setAttribute('text', 'value: ' + targetNode.title + '; align: center; width: 1.5; color: #ffffff');
  text.setAttribute('position', '0 0.05 0.03');
  signGroup.appendChild(text);
  
  // Arrow icon (using cone primitive)
  const arrow = document.createElement('a-entity');
  arrow.setAttribute('geometry', 'primitive: cone; radiusBottom: 0.08; radiusTop: 0; height: 0.18');
  arrow.setAttribute('material', 'color: #ffd166; shader: flat');
  arrow.setAttribute('position', '0 -0.08 0.03');
  arrow.setAttribute('rotation', '0 0 180');
  arrow.setAttribute('animation__bob', 'property: position; to: 0 -0.12 0.03; dir: alternate; dur: 1000; loop: true; easing: easeInOutSine');
  signGroup.appendChild(arrow);
  
  // Pole/stand
  const pole = document.createElement('a-entity');
  pole.setAttribute('geometry', 'primitive: cylinder; radius: 0.02; height: 0.4');
  pole.setAttribute('material', 'color: #1e293b; shader: flat');
  pole.setAttribute('position', '0 -0.35 0');
  signGroup.appendChild(pole);
  
  // NEW: Add dashed line from camera to sign
  const lineEnt = document.createElement('a-entity');
  lineEnt.setAttribute('dashed-line', {
    start: { x: 0, y: -1.6, z: 0 },
    end:   { x: pos.x, y: pos.y -0.6, z: pos.z },
    color: '#ffd166',    // Blue to match sign color
    dashLen: 0.15,
    gapLen: 0.2,
    radius: 0.05,
    opacity: 0.5
  });
  pathLinesContainer.appendChild(lineEnt);
  
  // Make clickable
  signGroup.addEventListener('click', function() {
    if(!editMode) goToNode(neighbor.id);
  });
  
  return signGroup;
}

  function buildMiniMap() {
    console.log('Building mini map...');
    miniMapGroup.innerHTML = '';
    Object.values(nodes).forEach(function(node) {
      const cx = node.mapPos.x || 20;
      const cy = node.mapPos.y || 50;
      const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
      circle.setAttribute('cx', cx);
      circle.setAttribute('cy', cy);
      circle.setAttribute('r', 6);
      circle.setAttribute('fill', '#94a3b8');
      circle.setAttribute('data-node', node.id);
      circle.setAttribute('style','cursor:pointer');
      circle.addEventListener('click', function() {
        if(currentNodeId !== node.id) goToNode(node.id);
      });
      miniMapGroup.appendChild(circle);
      
      const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
      txt.setAttribute('x', cx + 10); 
      txt.setAttribute('y', cy + 4);
      txt.setAttribute('font-size', 8); 
      txt.setAttribute('fill', '#cbd5e1');
      txt.textContent = node.title.split(' ')[0];
      miniMapGroup.appendChild(txt);
    });
  }

  function updateMiniMapActive(nodeId){
    const circles = miniMapGroup.querySelectorAll('circle');
    circles.forEach(function(c) {
      const isActive = c.getAttribute('data-node') === nodeId;
      c.setAttribute('fill', isActive ? '#0b74de' : '#94a3b8');
      c.setAttribute('r', isActive ? 8 : 6);
    });
  }

  function createNavigationForNode(node){
    console.log('Creating navigation for node:', node.id, 'with', node.neighbors.length, 'neighbors');
    
    // Clear existing
    hotspotsContainer.innerHTML = '';
    signsContainer.innerHTML = '';
    pathLinesContainer.innerHTML = '';
    
    let signsCreated = 0;
    let hotspotsCreated = 0;
    
    node.neighbors.forEach(function(n) {
      const targetNode = nodes[n.id];
      if(!targetNode) {
        console.warn('Target node not found:', n.id);
        return;
      }
      
      // Create 3D sign if enabled
      if((n.use3DSign !== false) && showSigns) {
        const sign = create3DSign(n, targetNode);
        signsContainer.appendChild(sign);
        signsCreated++;
      }
      
      // Create hotspot ring if enabled
      if(n.useHotspot !== false) {
        const pos = sphericalToCartesian(n.yaw || 0, n.pitch || 0, n.jauh);
        const ent = document.createElement('a-entity');
        ent.setAttribute('geometry','primitive: ring; radiusInner: 0.12; radiusOuter: 0.18');
        ent.setAttribute('material','color: #ffd166; shader: flat; opacity: 0.92');
        ent.setAttribute('position', pos.x + ' ' + pos.y + ' ' + pos.z);
        ent.setAttribute('rotation', '0 ' + (-n.yaw) + ' 0');
        ent.setAttribute('class', 'hotspot');
        ent.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 900; loop: true; to: 1.15 1.15 1.15; easing: easeInOutSine');
        ent.setAttribute('data-target', n.id);

        const txt = document.createElement('a-entity');
        txt.setAttribute('text', 'value: ' + targetNode.title + '; align: center; width: 2.4; color: #e6eef6');
        txt.setAttribute('position','0 -0.28 0');
        ent.appendChild(txt);

        ent.addEventListener('click', function(e) {
          const target = e.currentTarget.getAttribute('data-target');
          if(target && !editMode) goToNode(target);
        });

        hotspotsContainer.appendChild(ent);

        // NEW: dashed line from user (camera) to hotspot
// NEW: dashed line from user (camera) to hotspot
const lineEnt = document.createElement('a-entity');

// Start point = user viewpoint (cameraRig is at 0 1.6 0 in your scene)
lineEnt.setAttribute('dashed-line', {
  start: { x: 0, y: -1.6, z: 0 },
  end:   { x: pos.x, y: pos.y-0.5, z: pos.z },
  color: '#ffd166',
  dashLen: 0.15,        // Longer dashes
  gapLen: 0.2,        // Bigger gaps
  radius: 0.05,        // MUCH thicker (was 0.02)
  opacity: 0.5         // Full opacity
});

pathLinesContainer.appendChild(lineEnt);

        hotspotsCreated++;
      }
    });
    
    console.log('Created', signsCreated, '3D signs and', hotspotsCreated, 'hotspots');
  }

  function showLoader(show){
    if(show){ loader.classList.add('show'); }
    else { loader.classList.remove('show'); }
  }

  function goToNode(nodeId){
    if(isTransitioning) return;
    const node = nodes[nodeId];
    if(!node) {
      console.warn('Unknown node', nodeId); 
      statusEl.innerHTML = '<span class="error">Node not found!</span>';
      return;
    }
    
    console.log('Going to node:', nodeId);
    isTransitioning = true;
    showLoader(true);
    statusEl.textContent = 'Loading ' + node.title + '‚Ä¶';
    
    setTimeout(function() {
      try {
        sky.setAttribute('src', node.src);
        createNavigationForNode(node);
        
        currentNodeId = nodeId;
        locationLabel.textContent = node.title + ' ‚Äî 360¬∞ image';
        statusEl.textContent = 'Viewing: ' + node.title;
        updateMiniMapActive(nodeId);
        
        if(editMode) {
          populateTargetSelect();
          updateHotspotList();
        }
        
        if(debugMode) {
          console.log('Loaded node:', nodeId, 'with', node.neighbors.length, 'neighbors');
        }

      } catch(e){
        console.error('Error loading node:', e);
        statusEl.innerHTML = '<span class="error">Error: ' + e.message + '</span>';
      } finally{
        showLoader(false);
        isTransitioning = false;
      }
    });
  }

// Auto-journey from Lobby -> Hall1 -> Hall2 -> Hall3 -> Hall4 -> Hall5 -> Hall6 (Clinic)
// Auto-journey from Lobby -> Hall1 -> Hall2 -> Hall3 -> Hall4 -> Hall5 -> Hall6 (Clinic)
function ToClinic() {
  // Prevent double-trigger if user spams the button
  if (journeyInProgress) {
    statusEl.textContent = "Journey already in progress‚Ä¶";
    return;
  }
  journeyInProgress = true;

  const path = ["lobby", "hall1", "hall2", "hall3", "hall4", "hall5", "Clinic"];
  const dwellTime = 1400; // ms per location (includes 300ms loader inside goToNode)
  let index = 0;

  function step() {
    const nodeId = path[index];

    // On first step, if already at lobby, don‚Äôt reload, just start the journey
    if (index === 0 && currentNodeId === nodeId) {
      statusEl.textContent = "Starting journey to Clinic";
    } else {
      goToNode(nodeId); // uses existing transition+loader logic
    }

    // Update status text for flavor
    if (index < path.length - 1) {
      statusEl.textContent = "Passing: " + nodes[nodeId].title;
    } else {
      statusEl.textContent = "Arrived at Clinic (Hall 6)";
      journeyInProgress = false; // journey done
      return; // stop recursion
    }

    index++;
    // Schedule next hop
    setTimeout(step, dwellTime);
  }

  // Kick off the first step
  step();
}



  function toggleDebug(){
    debugMode = !debugMode;
    const hotspots = document.querySelectorAll('.hotspot');
    hotspots.forEach(function(h) {
      if(debugMode){
        h.setAttribute('material', 'color: #ef4444; opacity: 0.8');
      } else {
        h.setAttribute('material', 'color: #ffd166; opacity: 0.92');
      }
    });
    
    const signs = document.querySelectorAll('.sign-clickable');
    signs.forEach(function(s) {
      if(debugMode){
        s.setAttribute('material', 'color: #ef4444; opacity: 0.9');
      } else {
        s.setAttribute('material', 'color: #0b74de; opacity: 0.95');
      }
    });
    
    statusEl.textContent = debugMode ? 'Debug mode ON' : 'Debug mode OFF';
    console.log('Debug mode:', debugMode);
  }

  function toggleSigns(){
    showSigns = !showSigns;
    const btn = document.getElementById('btn-toggle-signs');
    btn.style.background = showSigns ? '' : '#dc2626';
    
    if(currentNodeId) {
      createNavigationForNode(nodes[currentNodeId]);
    }
    
    statusEl.textContent = showSigns ? '3D Signs visible' : '3D Signs hidden';
    console.log('Signs visibility:', showSigns);
  }

  // Edit Mode Functions
  function toggleEditMode(){
    editMode = !editMode;
    const panel = document.getElementById('editPanel');
    const btn = document.getElementById('btn-edit-mode');
    
    if(editMode){
      panel.style.display = 'block';
      btn.style.background = '#059669';
      populateTargetSelect();
      updateHotspotList();
      enableSceneClicking();
      statusEl.textContent = 'Edit Mode: Click in view to place navigation points';
    } else {
      panel.style.display = 'none';
      btn.style.background = '';
      disableSceneClicking();
      statusEl.textContent = 'Edit mode OFF';
    }
    console.log('Edit mode:', editMode);
  }

  function populateTargetSelect(){
    const select = document.getElementById('targetSelect');
    select.innerHTML = '<option value="">-- Select destination --</option>';
    
    Object.values(nodes).forEach(function(node) {
      if(node.id !== currentNodeId){
        const opt = document.createElement('option');
        opt.value = node.id;
        opt.textContent = node.title;
        select.appendChild(opt);
      }
    });
  }

  function enableSceneClicking(){
    const scene = document.querySelector('a-scene');
    scene.addEventListener('click', handleSceneClick);
  }

  function disableSceneClicking(){
    const scene = document.querySelector('a-scene');
    scene.removeEventListener('click', handleSceneClick);
  }

  function handleSceneClick(event){
    if(!editMode) return;
    
    const camera = document.querySelector('#camera');
    const rotation = camera.getAttribute('rotation');
    
    lastClickedYaw = rotation.y;
    lastClickedPitch = rotation.x;
    
    const info = document.getElementById('clickInfo');
    info.innerHTML = 'Yaw: <strong>' + lastClickedYaw.toFixed(1) + '¬∞</strong><br>Pitch: <strong>' + lastClickedPitch.toFixed(1) + '¬∞</strong>';
    
    const targetSelect = document.getElementById('targetSelect');
    const addBtn = document.getElementById('btn-add-hotspot');
    addBtn.disabled = !targetSelect.value;
    
    createTemporaryMarker(lastClickedYaw, lastClickedPitch);
  }

  function createTemporaryMarker(yaw, pitch){
    const existing = document.querySelector('.temp-marker');
    if(existing) existing.remove();
    
    const pos = sphericalToCartesian(yaw, pitch, 2.7);
    const marker = document.createElement('a-entity');
    marker.setAttribute('class', 'temp-marker');
    marker.setAttribute('geometry', 'primitive: sphere; radius: 0.1');
    marker.setAttribute('material', 'color: #10b981; shader: flat; opacity: 0.8');
    marker.setAttribute('position', pos.x + ' ' + pos.y + ' ' + pos.z);
    marker.setAttribute('animation', 'property: scale; to: 1.3 1.3 1.3; dir: alternate; loop: true; dur: 500');
    
    hotspotsContainer.appendChild(marker);
  }

  function addHotspot(){
    const targetSelect = document.getElementById('targetSelect');
    const targetId = targetSelect.value;
    
    if(!targetId || !currentNodeId) return;
    
    const use3DSign = document.getElementById('use3DSign').checked;
    const useHotspot = document.getElementById('useHotspot').checked;
    
    const currentNode = nodes[currentNodeId];
    const existingIndex = currentNode.neighbors.findIndex(function(n) { return n.id === targetId; });
    
    if(existingIndex >= 0){
      currentNode.neighbors[existingIndex] = {
        id: targetId,
        yaw: lastClickedYaw,
        pitch: lastClickedPitch,
        use3DSign: use3DSign,
        useHotspot: useHotspot
      };
      statusEl.textContent = 'Updated navigation point to ' + nodes[targetId].title;
    } else {
      currentNode.neighbors.push({
        id: targetId,
        yaw: lastClickedYaw,
        pitch: lastClickedPitch,
        use3DSign: use3DSign,
        useHotspot: useHotspot
      });
      statusEl.textContent = 'Added navigation point to ' + nodes[targetId].title;
    }
    
    createNavigationForNode(currentNode);
    updateHotspotList();
    
    const temp = document.querySelector('.temp-marker');
    if(temp) temp.remove();
    
    targetSelect.value = '';
    document.getElementById('btn-add-hotspot').disabled = true;
    document.getElementById('clickInfo').textContent = 'Click in view to place next point';
  }

  function removeHotspot(targetId){
    const currentNode = nodes[currentNodeId];
    currentNode.neighbors = currentNode.neighbors.filter(function(n) { return n.id !== targetId; });
    
    createNavigationForNode(currentNode);
    updateHotspotList();
    statusEl.textContent = 'Removed navigation point';
  }

  function updateHotspotList(){
    const list = document.getElementById('hotspotList');
    const currentNode = nodes[currentNodeId];
    
    if(!currentNode || currentNode.neighbors.length === 0){
      list.innerHTML = '<div style="font-size:11px;color:#64748b;padding:8px">No navigation points yet</div>';
      return;
    }
    
    list.innerHTML = '';
    currentNode.neighbors.forEach(function(n) {
      const item = document.createElement('div');
      item.className = 'hotspot-item';
      const signType = (n.use3DSign ? 'üè∑Ô∏è' : '') + (n.useHotspot ? '‚≠ï' : '');
      item.innerHTML = '<div><strong>' + nodes[n.id].title + '</strong> ' + signType + '<br>' +
        '<span style="color:#94a3b8">Yaw: ' + n.yaw.toFixed(1) + '¬∞ | Pitch: ' + n.pitch.toFixed(1) + '¬∞</span></div>' +
        '<button class="btn-remove" onclick="window.appRemoveHotspot(\'' + n.id + '\')">Remove</button>';
      list.appendChild(item);
    });
  }

  function exportConfig(){
    const config = JSON.stringify(nodes, null, 2);
    
    const blob = new Blob([config], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'uitm-hospital-config.json';
    a.click();
    URL.revokeObjectURL(url);
    
    statusEl.textContent = 'Configuration exported!';
    
    console.log('=== CONFIGURATION ===');
    console.log(config);
    console.log('===================');
  }

  function init(){
    console.log('Initializing app...');
    
    // Initialize DOM references
    sky = document.querySelector('#sky');
    hotspotsContainer = document.querySelector('#hotspots');
    signsContainer = document.querySelector('#signs');
    pathLinesContainer = document.querySelector('#pathlines');
    loader = document.getElementById('loader');
    statusEl = document.getElementById('status');
    locationLabel = document.getElementById('locationLabel');
    miniMapGroup = document.querySelector('#nodesSvg');
    
    console.log('DOM elements found:', {
      sky: !!sky,
      hotspotsContainer: !!hotspotsContainer,
      signsContainer: !!signsContainer,
      loader: !!loader,
      statusEl: !!statusEl,
      locationLabel: !!locationLabel,
      miniMapGroup: !!miniMapGroup
    });
    
    // Build mini map
    buildMiniMap();
    console.log('Mini map built');
    
    // Bind UI buttons
    document.getElementById('btn-recenter').addEventListener('click', ToClinic);
    // document.getElementById('btn-debug').addEventListener('click', toggleDebug);
    // document.getElementById('btn-edit-mode').addEventListener('click', toggleEditMode);
    // document.getElementById('btn-close-edit').addEventListener('click', toggleEditMode);
    // document.getElementById('btn-add-hotspot').addEventListener('click', addHotspot);
    // document.getElementById('btn-export').addEventListener('click', exportConfig);
    // document.getElementById('btn-toggle-signs').addEventListener('click', toggleSigns);
    
    document.getElementById('targetSelect').addEventListener('change', function(e) {
      const addBtn = document.getElementById('btn-add-hotspot');
      addBtn.disabled = !e.target.value;
    });
    
    // Expose removeHotspot to global scope for inline onclick
    window.appRemoveHotspot = removeHotspot;
    
    console.log('Event listeners attached');
    
    // Wait for A-Frame scene to be ready
    const scene = document.querySelector('a-scene');
    
    const startApp = function() {
      console.log('Scene loaded! Re-querying scene elements...');
      
      // Re-query scene elements after A-Frame loads
      sky = document.querySelector('#sky');
      hotspotsContainer = document.querySelector('#hotspots');
      signsContainer = document.querySelector('#signs');
      
      console.log('Scene elements after load:', {
        sky: !!sky,
        hotspotsContainer: !!hotspotsContainer,
        signsContainer: !!signsContainer
      });
      
      // Start navigation
      setTimeout(function() {
        console.log('Starting at lobby node...');
        goToNode('lobby');
      }, 200);
    };
    
    if(scene.hasLoaded){
      console.log('Scene already loaded');
      startApp();
    } else {
      console.log('Waiting for scene to load...');
      scene.addEventListener('loaded', startApp);
    }
  }

  // Start when DOM is ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  console.log('Script loaded successfully');
})();
</script>
</body>
</html>
